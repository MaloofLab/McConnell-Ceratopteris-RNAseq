---
title: "03_EdgeR"
author: "Julin Maloof"
date: "2024-12-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(edgeR)
```

```{r}
counts.data <- read_csv("../output/ht-seq-counts-combined.csv.gz")
head(counts.data)
```

```{r}
counts.data <- counts.data %>%
  rename_with(.fn = ~ str_remove(.x, "RESUB-")) %>%
  rename_with(.fn = ~ str_replace(.x, "(male|mature)-", "\\1_"))
```


```{r}
sample.description <- tibble(sample=colnames(counts.data)[-1]) %>%
  mutate(gt=str_extract(sample, "^[a-zA-Z0-9]*"),
         base_gt=str_remove(gt, "[0-9]+"),
         tissue=str_remove(sample, "^[a-zA-Z0-9]*-")) %>%
  separate(tissue, into=c("tissue", "rep"), sep = "-", fill="right", extra="merge") %>%
  mutate( group=str_c(base_gt, "-", tissue))

sample.description
```

```{r}
counts.data %>% filter(!str_detect(gene_ID, "Ceric"))
```

```{r}
counts.data <- counts.data %>% filter(str_detect(gene_ID, "Ceric"))
```

remove low read genes:

```{r}
counts.data <- counts.data[rowSums(counts.data[,-1] > 5) >= 3,]
```

```{r}
counts.matrix <- counts.data %>% select(-gene_ID) %>% as.matrix()
rownames(counts.matrix) <- counts.data$gene_ID

dge.data <- DGEList(counts=counts.matrix, 
                    group=sample.description$group)
dim(dge.data) 
dge.data <- calcNormFactors(dge.data, method = "TMM")
dge.data$samples # look at the normalization factors
```

NOTE THAT THE S5 SAMPLES HAVE MUCH LOWER NORM.FACTORS THAN EVERYTHING ELSE.  WE MAY WANT TO HANDLE THESE DIFFERNETLY, DEPENDING ON WHAT THESE SAMPLES ARE

## MAKE AND MDS

```{r}
mdsvals <- plotMDS(dge.data, plot = FALSE) # get the MDS values for plotting
```


```{r}
mdsvals2 <- tibble(x=mdsvals$x, y=mdsvals$y, sample=rownames(dge.data$samples)) %>%
  inner_join(sample.description)


mdsvals2 %>%  ggplot(aes(x=x, y=y, color=tissue, shape=base_gt)) +
  scale_color_brewer(type="qual", palette = 1) +
  theme_bw() +
  geom_point(size=3) 
```

